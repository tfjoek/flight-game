import mysql.connector
import os
import random
import time
from geopy.distance import distance as geopy_distance
from tarina import hae_tarina  # Importoi tarina uudesta tiedostosta

def create_connection():
    try:
        conn = mysql.connector.connect(
            host='127.0.0.1',
            port=3306,
            database='flight_game',
            user='vennilim',
            password='kappa123',
            charset='utf8mb4',
            collation='utf8mb4_general_ci',
            autocommit=True
        )
        if conn.is_connected():
            return conn
        else:
            print("Yhteytt√§ ei voitu muodostaa.")
            return None
    except mysql.connector.Error as err:
        print(f"Tietokantavirhe: {err}")
        return None


def get_star_rating(difficulty):
    stars = '‚≠ê' * difficulty
    spaced_stars = ' '.join(stars)
    return spaced_stars

def get_airport_info(icao_code):
    conn = create_connection()
    if conn:
        cursor = conn.cursor(dictionary=True)
        query = "SELECT name, owner, latitude_deg, longitude_deg, difficulty FROM airport WHERE ident = %s"
        cursor.execute(query, (icao_code,))
        airport = cursor.fetchone()
        cursor.close()
        conn.close()
        return airport
    return None

def get_player_status(player_id):
    conn = create_connection()
    if conn:
        cursor = conn.cursor(dictionary=True)
        query = "SELECT location, fuel, war_points FROM game WHERE id = %s"
        cursor.execute(query, (player_id,))
        player = cursor.fetchone()

        cursor.execute("SELECT COUNT(*) AS remaining_airports FROM airport WHERE owner = 'Russia'")
        remaining_airports = cursor.fetchone()['remaining_airports']

        cursor.close()
        conn.close()

        return player, remaining_airports
    return None, None

def list_airports_by_owner(owner, emoji):
    os.system('cls' if os.name == 'nt' else 'clear')
    conn = create_connection()
    if conn:
        cursor = conn.cursor(dictionary=True)
        query = "SELECT ident, name, difficulty FROM airport WHERE owner = %s ORDER BY name"
        cursor.execute(query, (owner,))
        airports = cursor.fetchall()
        cursor.close()
        conn.close()

        if airports:
            print(f"Lentokent√§t {emoji} {owner}:n hallussa:")
            for airport in airports:
                stars = get_star_rating(airport['difficulty'])
                print(f"{emoji} - {airport['ident']} ({airport['name']}) {stars}")
        else:
            print(f"Ei lentokentti√§ {emoji} {owner}:n hallussa.")

def list_all_airports():
    os.system('cls' if os.name == 'nt' else 'clear')
    conn = create_connection()
    if conn:
        cursor = conn.cursor(dictionary=True)
        query = "SELECT ident, name, owner, difficulty FROM airport ORDER BY name"
        cursor.execute(query)
        airports = cursor.fetchall()
        cursor.close()
        conn.close()

        if airports:
            print("Kaikki lentokent√§t aakkosj√§rjestyksess√§:")
            for airport in airports:
                emoji = "üü¶" if airport['owner'] == 'Finland' else "üü•"
                stars = get_star_rating(airport['difficulty'])
                print(f"{emoji} - {airport['ident']} ({airport['name']}) {stars}")
        else:
            print("Ei lentokentti√§ l√∂ydetty.")

def open_store(itemBoostPercentage):
    conn = create_connection()
    if conn:
        cursor = conn.cursor(dictionary=True)
        query = "SELECT id, item, effect, price FROM store"
        cursor.execute(query)
        store = cursor.fetchall()

        cursor.close()
        conn.close()

        for item in store:
            print(f"{item['id']} {item['item']} {item['price']}‚Ç¨, {item['effect']}.")
        while True:
            storeChoice = input("Valitse numerolla:")
            if storeChoice == '1':
                itemBoostPercentage = 10
                break
            elif storeChoice == '2':
                itemBoostPercentage = 20
                break
            else:
                print("FAIL!")

    return itemBoostPercentage

def list_nearest_airports(player_location, limit=5):
    os.system('cls' if os.name == 'nt' else 'clear')
    conn = create_connection()
    if conn:
        cursor = conn.cursor(dictionary=True)
        query = """
            SELECT ident, name, latitude_deg, longitude_deg, owner, difficulty
            FROM airport
            WHERE owner = 'Russia'
        """
        cursor.execute(query)
        airports = cursor.fetchall()
        cursor.close()
        conn.close()

        player_airport = get_airport_info(player_location)
        if player_airport:
            player_coords = (player_airport['latitude_deg'], player_airport['longitude_deg'])

            airports_with_distance = []
            for airport in airports:
                airport_coords = (airport['latitude_deg'], airport['longitude_deg'])
                distance = geopy_distance(player_coords, airport_coords).km
                airports_with_distance.append((airport, distance))

            nearest_airports = sorted(airports_with_distance, key=lambda x: x[1])[:limit]
            print("\nValitse seuraava kohde:")
            for airport, distance in nearest_airports:
                stars = get_star_rating(airport['difficulty'])
                print(f"‚Ä¢ {airport['ident']} ({airport['name']}) {stars} üü• - Et√§isyys: {int(distance)} km")
        else:
            print("Nykyisen sijainnin tietoja ei l√∂ydy.")

def update_airport_owner(icao_code, new_owner):
    conn = create_connection()
    if conn:
        cursor = conn.cursor()
        query = "UPDATE airport SET owner = %s WHERE ident = %s"
        cursor.execute(query, (new_owner, icao_code))
        conn.commit()
        cursor.close()
        conn.close()

def update_player_fuel(player_id, fuel_cost):
    conn = create_connection()
    if conn:
        cursor = conn.cursor()
        query = "UPDATE game SET fuel = fuel - %s WHERE id = %s"
        cursor.execute(query, (fuel_cost, player_id))
        conn.commit()
        cursor.close()
        conn.close()

#debug 
def set_player_fuel_debug(player_id, new_fuel):
    conn = create_connection()
    if conn:
        cursor = conn.cursor()
        query = "UPDATE game SET fuel = %s WHERE id = %s"
        cursor.execute(query, (new_fuel, player_id))
        conn.commit()
        cursor.close()
        conn.close()




def move_player(player_id, destination_icao):
    conn = create_connection()
    if conn:
        cursor = conn.cursor(dictionary=True)
        cursor.execute("SELECT location, fuel FROM game WHERE id = %s", (player_id,))
        player = cursor.fetchone()

        if player:
            current_location = player['location']
            current_fuel = player['fuel']

            current_airport = get_airport_info(current_location)
            destination_airport = get_airport_info(destination_icao)

            if current_airport and destination_airport:
                # Check if the destination airport is controlled by Russia
                if destination_airport['owner'] == 'Russia':
                    print("\n‚ö†Ô∏è VAROITUS! Yrit√§t liikkua Ven√§j√§n omistamaan lentokentt√§√§n.")
                    print("Sinun t√§ytyy hy√∂k√§t√§ ennen kuin voit siirty√§ sinne.")
                    print("1 - Hy√∂kk√§√§ lentokent√§lle")
                    print("2 - Peruuta")

                    attack_choice = input("Valitse toiminto (1 tai 2): ")

                    if attack_choice == '1':
                        attack_airport(player_id, destination_icao)
                        return  # Exit the move function after the attack process
                    elif attack_choice == '2':
                        print("Liikkuminen peruutettu.")
                        return  # Exit the move function without moving the player
                    else:
                        print("‚ö†Ô∏è Virheellinen valinta, liikkuminen peruutettu.")
                        return  # Exit the move function without moving the player

                # If the airport is not controlled by Russia, proceed with the move
                current_coords = (current_airport['latitude_deg'], current_airport['longitude_deg'])
                destination_coords = (destination_airport['latitude_deg'], destination_airport['longitude_deg'])
                distance = geopy_distance(current_coords, destination_coords).km
                fuel_cost = distance  # Fuel cost equals the distance traveled

                if fuel_cost > current_fuel:
                    print(f"‚ùå Sinulla ei ole tarpeeksi polttoainetta t√§h√§n matkaan. Tarvittava polttoaine: {fuel_cost:.2f} km.")
                else:
                    new_fuel = current_fuel - fuel_cost
                    cursor.execute("UPDATE game SET location = %s, fuel = %s WHERE id = %s", (destination_icao, new_fuel, player_id))
                    conn.commit()
                    print(f"Olet nyt saapunut kohteeseen {destination_icao}. Matka oli {distance:.2f} km, polttoainetta j√§ljell√§: {new_fuel:.2f} km.")
            else:
                print("Virhe: Kohteen tai l√§ht√∂paikan tietoja ei l√∂ytynyt.")
        cursor.close()
        conn.close()


def attack_airport(player_id, destination_icao):
    destination_airport = get_airport_info(destination_icao)
    player = get_player_status(player_id)[0]

    if destination_airport and destination_airport['owner'] == 'Russia' and player:
        current_airport = get_airport_info(player['location'])

        # Lasketaan et√§isyys nykyisest√§ sijainnista kohteeseen
        current_coords = (current_airport['latitude_deg'], current_airport['longitude_deg'])
        destination_coords = (destination_airport['latitude_deg'], destination_airport['longitude_deg'])
        distance = geopy_distance(current_coords, destination_coords).km

        # Vaikeustason m√§√§rittely
        difficulty = destination_airport['difficulty']
        fast_attack_success_range = {
            1: (35, 45),  # Muutettu vaikeammaksi
            2: (30, 40),
            3: (25, 35),
            4: (20, 30),
            5: (15, 25)
        }
        precise_attack_success_range = {
            1: (50, 60),  # Muutettu vaikeammaksi
            2: (45, 55),
            3: (40, 50),
            4: (35, 45),
            5: (30, 40)
        }

        print("\n‚öîÔ∏è Valitse hy√∂kk√§ystyyli:")
        print(f"1. ‚ö° Nopeampi hy√∂kk√§ys (v√§hemm√§n tarkka) - Polttoainekustannus: {distance * 0.5:.2f} km")
        print(f"2. üéØ Tarkempi hy√∂kk√§ys (suurempi onnistumismahdollisuus) - Polttoainekustannus: {distance:.2f} km")

        attack_choice = input("\nValintasi (1 tai 2): ")

        if attack_choice == '1':
            success_chance_range = fast_attack_success_range[difficulty]
            success_chance = random.randint(*success_chance_range)
            fuel_cost = distance * 0.5  # Nopeampi hy√∂kk√§ys kuluttaa v√§hemm√§n polttoainetta

            if fuel_cost > player['fuel']:
                print("‚ùå Sinulla ei ole tarpeeksi polttoainetta hy√∂k√§t√§ t√§h√§n kohteeseen!")
            else:
                print(f"\n‚ö° Valitsit nopeamman hy√∂kk√§yksen! Onnistumistodenn√§k√∂isyys: {success_chance}%, Polttoainekustannus: {fuel_cost:.2f} km")
                print(f"üöÄ Polttoainetta j√§ljell√§ ennen hy√∂kk√§yst√§: {player['fuel']:.2f} km")
                time.sleep(1)
                print("\nüõ©Ô∏è Hy√∂kk√§ys k√§ynniss√§...")
                time.sleep(2)
                print("\nüöÄ Ammuit raketin niit√§ p√§in!")
                time.sleep(2)

                if random.randint(1, 100) <= success_chance:
                    print(f"üèÜ Hy√∂kk√§ys kohteeseen {destination_airport['name']} onnistui! Hyvin pelattu! Lentokentt√§ on nyt Suomen hallinnassa.")
                    update_airport_owner(destination_icao, 'Finland')
                else:
                    print("‚ùå Hy√∂kk√§ys ep√§onnistui! Menetit polttoainetta, mutta kohde pysyi Ven√§j√§n hallinnassa...")
                    update_player_fuel(player_id, fuel_cost)
                    print(f"Polttoainetta j√§ljell√§ hy√∂kk√§yksen j√§lkeen: {player['fuel'] - fuel_cost:.2f} km")

        elif attack_choice == '2':
            success_chance_range = precise_attack_success_range[difficulty]
            success_chance = random.randint(*success_chance_range)
            fuel_cost = distance  # Tarkempi hy√∂kk√§ys kuluttaa enemm√§n polttoainetta

            if fuel_cost > player['fuel']:
                print("‚ùå Sinulla ei ole tarpeeksi polttoainetta hy√∂k√§t√§ t√§h√§n kohteeseen!")
            else:
                print(f"\nüéØ Valitsit tarkemman hy√∂kk√§yksen! Onnistumistodenn√§k√∂isyys: {success_chance}%, Polttoainekustannus: {fuel_cost:.2f} km")
                print(f"üöÄ Polttoainetta j√§ljell√§ ennen hy√∂kk√§yst√§: {player['fuel']:.2f} km")
                time.sleep(1)
                print("\nüõ©Ô∏è Hy√∂kk√§ys k√§ynniss√§...")
                time.sleep(2)
                print("\nüöÄ Hiivit heid√§n taakse... ja HY√ñKK√Ñ√ÑT!")
                time.sleep(2)

                if random.randint(1, 100) <= success_chance:
                    print(f"üèÜ Hy√∂kk√§ys kohteeseen {destination_airport['name']} onnistui! Lentokentt√§ on nyt Suomen hallinnassa.")
                    update_airport_owner(destination_icao, 'Finland')
                else:
                    print("‚ùå Hy√∂kk√§ys ep√§onnistui! Menetit polttoainetta, mutta kohde pysyi Ven√§j√§n hallinnassa...")
                    update_player_fuel(player_id, fuel_cost)
                    print(f"Polttoainetta j√§ljell√§ hy√∂kk√§yksen j√§lkeen: {player['fuel'] - fuel_cost:.2f} km")
        else:
            print("‚ö†Ô∏è Virheellinen valinta, hy√∂kk√§ys peruutettu.")
    else:
        print("‚ö†Ô∏è Et voi hy√∂k√§t√§ t√§h√§n lentokentt√§√§n, koska se ei ole Ven√§j√§n hallussa.")




def display_player_status(player, remaining_airports):
    current_airport = get_airport_info(player['location'])
    if current_airport:
        emoji = "üü¶" if current_airport['owner'] == 'Finland' else "üü•"
        stars = get_star_rating(current_airport['difficulty'])
        print(f"\n‚úàÔ∏è  Pelaaja on lentokent√§ll√§: {emoji} {current_airport['name']} ({player['location']}) {stars}")
    else:
        print("Virhe: Lentokent√§n tietoja ei l√∂ytynyt.")

    print(f"üöÄ Polttoainetta: {player['fuel']} km")
    print(f"üéØ Vapauttamattomia kentti√§: {remaining_airports}")
    print(f"üõ°Ô∏è  Sotapisteet: {player['war_points']}")

def wait_for_enter():
    input("Paina enter jatkaaksesi...")

def display_story():
    tarina = hae_tarina()
    tarinaHalu = input("Halutako lukea tarinan (Y/N): ")
    if tarinaHalu.upper() == 'Y':
        for osa in tarina:
            os.system('cls' if os.name == 'nt' else 'clear')
            print(osa)
            wait_for_enter()

if __name__ == "__main__":
    display_story()
    os.system('cls' if os.name == 'nt' else 'clear')
    print("Tarinan loppu. Paina enter aloittaaksesi seikkailun...")
    wait_for_enter()

    player_id = '1'
    itemBoostPercentage = 0  

    while True:
        os.system('cls' if os.name == 'nt' else 'clear')
        player, remaining_airports = get_player_status(player_id)
        if player:
            display_player_status(player, remaining_airports)
        else:
            print("Pelaajan tietojen haku ep√§onnistui.")

        print("\nüìí‚úèÔ∏è: Valitse seuraava toimintasi:")
        print("1 - Selaa lentokentti√§")
        print("2 - Hy√∂kk√§√§ lentokent√§lle")
        print("3 - Liiku lentokent√§lle")
        print("4 - Debug: Muuta pelaajan polttoainetta")
        print("5 - Listaa kaikki lentokent√§t")
        print("6 - Avaa kauppa") 

        choice = input("Valitse vaihtoehto: ")

        if choice == '1':
            print("\n1 - Listaa Suomen hallussa olevat lentokent√§t")
            print("2 - Listaa Ven√§j√§n vallassa olevat lentokent√§t")
            print("3 - Listaa lentokent√§t et√§isyyden mukaan")
            print("4 - Listaa lentokent√§t aakkosj√§rjestyksess√§")
            sub_choice = input("Valitse luokittelu: ")

            if sub_choice == '1':
                list_airports_by_owner('Finland', 'üü¶')
            elif sub_choice == '2':
                list_airports_by_owner('Russia', 'üü•')
            elif sub_choice == '3':
                list_nearest_airports(player['location'])
            elif sub_choice == '4':
                list_all_airports()
            else:
                print("‚ö†Ô∏è Virheellinen valinta.")
            wait_for_enter()
        elif choice == '2':
            print("Valitset hy√∂kk√§yskohteen l√§himmist√§ kohteista:")
            list_nearest_airports(player['location'])
            destination = input("\nüéØ Sy√∂t√§ hy√∂kk√§yskohteen ICAO-tunnus (esim. EFHK tai 'cancel' peruuttaaksesi): ").upper()
            if destination == 'CANCEL':
                print("Peruutettu.")
            else:
                attack_airport(player_id, destination)
            wait_for_enter()
        elif choice == '3':
            destination = input("\n‚úàÔ∏è Sy√∂t√§ kohteen ICAO-tunnus (esim. EFHK tai 'cancel' peruuttaaksesi): ").upper()
            if destination == 'CANCEL':
                print("Peruutettu.")
            else:
                move_player(player_id, destination)
            wait_for_enter()
        elif choice == '4':
            new_fuel = input("üîß Sy√∂t√§ uusi polttoainem√§√§r√§ (km): ")
            if new_fuel.isdigit():
                set_player_fuel_debug(player_id, int(new_fuel))
                print(f"Polttoainem√§√§r√§ p√§ivitetty: {new_fuel} km")
            else:
                print("Virheellinen sy√∂te, polttoainetta ei p√§ivitetty.")
            wait_for_enter()

        elif choice == '5':
            list_all_airports()
            wait_for_enter()
        elif choice == '6':  
            itemBoostPercentage = open_store(itemBoostPercentage)
            wait_for_enter()
        else:
            print("‚ö†Ô∏è Virheellinen valinta, jatketaan...")
            wait_for_enter()
